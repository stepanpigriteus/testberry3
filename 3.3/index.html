<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .api-config {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .api-config label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .api-config input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .load-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .load-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .load-box input {
            width: 150px;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
        }

        .load-box label {
            font-weight: 600;
            color: #495057;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .comments-section {
            padding: 20px;
            min-height: 400px;
        }

        .comment {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .comment:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .comment.nested {
            margin-left: 30px;
            border-left-color: #764ba2;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .comment-id {
            font-weight: 600;
            color: #667eea;
        }

        .comment-author {
            font-weight: 600;
            color: #28a745;
        }

        .comment-content {
            margin: 10px 0;
            line-height: 1.6;
            color: #212529;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .reply-form {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            display: none;
        }

        .reply-form.active {
            display: block;
        }

        .reply-form input,
        .reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .reply-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .reply-form-actions {
            display: flex;
            gap: 10px;
        }

        .new-comment {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
        }

        .new-comment h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .new-comment input,
        .new-comment textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .new-comment textarea {
            min-height: 100px;
            resize: vertical;
        }

        .new-comment-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 18px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #bee5eb;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó®Ô∏è –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h1>
            <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —Å –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π</p>
        </div>

        <div class="api-config">
            <label>üîó API Base URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
        </div>

        <div class="load-section">
            <div class="load-box">
                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ ID:</label>
                <input type="number" id="loadCommentId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" min="1" />
                <button class="btn btn-primary" onclick="loadCommentById()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="clearComments()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="info-box" style="margin-top: 15px;">
                <strong>‚ÑπÔ∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong>
                1. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã<br>
                2. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è<br>
                3. –í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç ID –≤—ã—à–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ä–µ–≤–æ
            </div>
        </div>

        <div class="comments-section" id="commentsSection">
            <div class="empty">üì≠ –í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤—ã—à–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
        </div>

        <div class="new-comment">
            <h3>‚úçÔ∏è –ù–æ–≤—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <input type="text" id="newCommentAuthor" placeholder="–í–∞—à–µ –∏–º—è" />
            <textarea id="newCommentText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <div class="new-comment-actions">
                <button class="btn btn-success" onclick="postComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentRootId = null;

        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim();
        }

        function clearComments() {
            document.getElementById('commentsSection').innerHTML = '<div class="empty">üì≠ –í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤—ã—à–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            document.getElementById('loadCommentId').value = '';
            currentRootId = null;
        }

        async function loadCommentById() {
            const idInput = document.getElementById('loadCommentId');
            const id = parseInt(idInput.value);

            if (!id || id < 1) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                return;
            }

            const section = document.getElementById('commentsSection');
            const apiUrl = getApiUrl();

            section.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è...</div>';

            try {
                const response = await fetch(`${apiUrl}/comments?parent=${id}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }

                const comment = await response.json();
                currentRootId = id;
                displayComment(comment);
            } catch (error) {
                section.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                console.error('Error loading comment:', error);
            }
        }

        function displayComment(comment) {
            const section = document.getElementById('commentsSection');
            section.innerHTML = '';
            section.appendChild(createCommentElement(comment, 0));
        }

        function createCommentElement(comment, level = 0) {
            const div = document.createElement('div');
            div.className = 'comment' + (level > 0 ? ' nested' : '');
            div.style.marginLeft = (level * 30) + 'px';
            div.id = `comment-${comment.id}`;

            const date = new Date(comment.created_at || comment.createdAt).toLocaleString('ru-RU');
            const isDeleted = comment.deleted_at || comment.deletedAt;

            const childrenCount = comment.children ? comment.children.length : 0;

            div.innerHTML = `
                <div class="comment-header">
                    <div class="comment-meta">
                        <span class="comment-id">ID: ${comment.id}</span>
                        <span class="comment-author"> | üë§ ${comment.author || '–ê–Ω–æ–Ω–∏–º'}</span>
                        ${comment.parent_id || comment.parentId ? ` | ‚Ü©Ô∏è –û—Ç–≤–µ—Ç –Ω–∞: ${comment.parent_id || comment.parentId}` : ' | üìå –ö–æ—Ä–Ω–µ–≤–æ–π'}
                        | üïê ${date}
                        ${childrenCount > 0 ? ` | üí¨ –û—Ç–≤–µ—Ç–æ–≤: ${childrenCount}` : ''}
                        ${isDeleted ? ' | ‚ùå –£–î–ê–õ–Å–ù' : ''}
                    </div>
                    ${!isDeleted ? `<button class="btn btn-danger" onclick="deleteComment(${comment.id}, ${childrenCount})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å${childrenCount > 0 ? ` (+ ${childrenCount} –æ—Ç–≤.)` : ''}</button>` : ''}
                </div>
                <div class="comment-content">${escapeHtml(comment.text || comment.content || '')}</div>
                ${!isDeleted ? `
                <div class="comment-actions">
                    <button class="btn btn-primary" onclick="toggleReplyForm(${comment.id})">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                </div>
                <div class="reply-form" id="reply-form-${comment.id}">
                    <input type="text" id="reply-author-${comment.id}" placeholder="–í–∞—à–µ –∏–º—è" />
                    <textarea id="reply-text-${comment.id}" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ID: ${comment.id}..."></textarea>
                    <div class="reply-form-actions">
                        <button class="btn btn-success" onclick="postReply(${comment.id})">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                        <button class="btn btn-secondary" onclick="toggleReplyForm(${comment.id})">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
                ` : ''}
            `;

            const container = document.createElement('div');
            container.appendChild(div);

            if (comment.children && comment.children.length > 0) {
                comment.children.forEach(child => {
                    container.appendChild(createCommentElement(child, level + 1));
                });
            }

            return container;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.classList.toggle('active');
        }

        async function postComment() {
            const authorInput = document.getElementById('newCommentAuthor');
            const textArea = document.getElementById('newCommentText');
            
            const author = authorInput.value.trim();
            const text = textArea.value.trim();

            console.log('Creating comment:', { author, text });

            if (!author) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            if (!text) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                return;
            }

            const apiUrl = getApiUrl();
            const payload = { 
                parent_id: null,
                text: text,
                author: author
            };

            console.log('Sending request to:', `${apiUrl}/comments`);
            console.log('Payload:', payload);

            try {
                const response = await fetch(`${apiUrl}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                const responseText = await response.text();
                console.log('Response text:', responseText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText || response.statusText}`);
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed result:', result);
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ' + responseText);
                }

                authorInput.value = '';
                textArea.value = '';
                
                const commentId = result.id || result.ID || result.Id;
                
                if (commentId) {

                    document.getElementById('loadCommentId').value = commentId;
                    alert(`‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω!\n\nID: ${commentId}\n\n–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π`);
                } else {
                    alert(`‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω!\n\n–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                console.error('Error creating comment:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${error.message}`);
            }
        }

        async function postReply(parentId) {
            const authorInput = document.getElementById(`reply-author-${parentId}`);
            const textArea = document.getElementById(`reply-text-${parentId}`);
            
            const author = authorInput.value.trim();
            const text = textArea.value.trim();

            console.log('Creating reply:', { parentId, author, text });

            if (!author) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            if (!text) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                return;
            }

            const apiUrl = getApiUrl();
            const payload = { 
                parent_id: parentId,
                text: text,
                author: author
            };

            console.log('Sending reply to:', `${apiUrl}/comments`);
            console.log('Payload:', payload);

            try {
                const response = await fetch(`${apiUrl}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Reply response status:', response.status);

                const responseText = await response.text();
                console.log('Reply response text:', responseText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText || response.statusText}`);
                }

                authorInput.value = '';
                textArea.value = '';
                toggleReplyForm(parentId);

                if (currentRootId) {
                    document.getElementById('loadCommentId').value = currentRootId;
                    await loadCommentById();
                }
                
                alert('‚úÖ –û—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω!');
            } catch (error) {
                console.error('Error creating reply:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
            }
        }

        async function deleteComment(id, childrenCount = 0) {
            const message = childrenCount > 0 
                ? `‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ID: ${id} –∏ –≤—Å–µ ${childrenCount} –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`
                : `‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ID: ${id}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;
            
            if (!confirm(message)) {
                return;
            }

            const apiUrl = getApiUrl();

            try {
                const response = await fetch(`${apiUrl}/comments/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }


                const commentEl = document.getElementById(`comment-${id}`);
                if (commentEl) {
                    commentEl.style.opacity = '0.5';
                    commentEl.style.backgroundColor = '#ffe6e6';
                }

                if (currentRootId) {
                    setTimeout(async () => {
                        document.getElementById('loadCommentId').value = currentRootId;
                        await loadCommentById();
                    }, 500);
                }
                
                const deletedMsg = childrenCount > 0 
                    ? `‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ID: ${id} –∏ ${childrenCount} –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω—ã!`
                    : `‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ID: ${id} —É–¥–∞–ª—ë–Ω!`;
                alert(deletedMsg);
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`);
                console.error('Error deleting comment:', error);
            }
        }

        document.getElementById('loadCommentId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadCommentById();
            }
        });
    </script>
</body>
</html>