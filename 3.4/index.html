<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WBF Image Manager</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      color: #333;
    }
    h1 { text-align: center; margin-bottom: 2rem; }
    .block {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input[type="file"], input[type="text"] {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      max-width: 400px;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
    img {
      max-width: 200px;
      margin: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .images { display: flex; flex-wrap: wrap; gap: 10px; }
    .status {
      margin-top: 10px;
      font-weight: bold;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>üß© WBF Image Manager</h1>

  <div class="block">
    <h2>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
    <input type="file" id="fileInput" accept="image/*" />
    <button id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <div class="status" id="uploadStatus"></div>
  </div>

  <div class="block">
    <h2>üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2>
    <input type="text" id="imageIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ image ID..." />
    <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <div class="status" id="statusText"></div>
    <div class="images" id="imageResults"></div>
  </div>

  <div class="block">
    <h2>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
    <input type="text" id="deleteId" placeholder="–í–≤–µ–¥–∏—Ç–µ image ID..." />
    <button id="deleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
    <div class="status" id="deleteStatus"></div>
  </div>

  <script>
    const API = "http://localhost:8080";

    // ---- UPLOAD ----
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      const statusEl = document.getElementById("uploadStatus");
      if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");

      const formData = new FormData();
      formData.append("image", file);

      statusEl.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
      const res = await fetch(`${API}/upload`, { method: "POST", body: formData });
      const text = await res.text();
      statusEl.textContent = text;

      // –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å id, –≤—ã–¥–µ–ª–∏–º –µ–≥–æ
      const match = text.match(/[0-9a-fA-F-]{36}/);
      if (match) {
        const id = match[0];
        statusEl.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ! ID: <b>${id}</b>`;
        document.getElementById("imageIdInput").value = id;
        document.getElementById("deleteId").value = id;
      }
    });

    // ---- CHECK STATUS / GET RESULT ----
    document.getElementById("checkBtn").addEventListener("click", async () => {
      const id = document.getElementById("imageIdInput").value.trim();
      const statusEl = document.getElementById("statusText");
      const imagesEl = document.getElementById("imageResults");
      if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");

      statusEl.textContent = "‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...";
      imagesEl.innerHTML = "";

      const res = await fetch(`${API}/image/${id}`);
      if (res.status === 202) {
        statusEl.textContent = "‚öôÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...";
        return;
      }
      if (!res.ok) {
        statusEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${res.status}`;
        return;
      }

      // –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è ZIP ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞—á–∞—Ç—å
      const contentType = res.headers.get("Content-Type");
      if (contentType.includes("application/zip")) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${id}_images.zip`;
        a.click();
        window.URL.revokeObjectURL(url);
        statusEl.textContent = "‚úÖ ZIP —Å–∫–∞—á–∞–Ω";
        return;
      }

      // –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª—Å—è JSON —Å –ø—É—Ç—è–º–∏
      const data = await res.json();
      statusEl.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ!";

      imagesEl.innerHTML = "";
      ["thumbnail_path", "watermark_path", "resized_path"].forEach(key => {
        if (data[key]) {
          const img = document.createElement("img");
          img.src = `${API}/${data[key]}`;
          img.alt = key;
          imagesEl.appendChild(img);
        }
      });
    });

    // ---- DELETE ----
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      const id = document.getElementById("deleteId").value.trim();
      const statusEl = document.getElementById("deleteStatus");
      if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");

      statusEl.textContent = "‚è≥ –£–¥–∞–ª—è–µ–º...";
      const res = await fetch(`${API}/image/${id}`, { method: "DELETE" });
      const text = await res.text();
      statusEl.textContent = text;
    });
  </script>
</body>
</html>
