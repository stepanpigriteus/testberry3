<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Event Booking Admin</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      background: #f2f4f5;
    }
    h2 {
      margin-top: 40px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .block {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #0077cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #005fa3;
    }
    pre {
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

  <h1>Панель API бронирования событий</h1>

  <div class="block">
    <h2>1. Создать пользователя</h2>
    <label>Email</label><input id="user_email" required>
    <label>Имя</label><input id="user_name" required>
    <label>Telegram ID</label><input id="user_telegram" required>
    <button onclick="createUser()">Создать</button>
    <pre id="user_result"></pre>
  </div>

  <div class="block">
    <h2>2. Создать событие</h2>
    <label>Название</label><input id="event_title" required>
    <label>Описание</label><textarea id="event_description" required></textarea>
    <label>Дата</label>
    <input id="event_date" type="datetime-local" required>
    <label>Всего мест</label><input id="event_total" type="number" value="100" required>
    <label>Доступно мест</label><input id="event_available" type="number" value="100" required>
    <label>Требует оплату</label><input id="event_payment" type="checkbox">
    <label>TTL брони (секунды)</label><input id="event_ttl" type="number" value="3600" required>
    <button onclick="createEventRequest()">Создать</button>
    <pre id="event_result"></pre>
  </div>

  <div class="block">
    <h2>3. Получить событие</h2>
    <label>ID события</label><input id="get_event_id" required>
    <button onclick="getEvent()">Получить</button>
    <pre id="get_event_result"></pre>
  </div>

  <div class="block">
    <h2>4. Забронировать место</h2>
    <label>ID события</label><input id="book_event_id" required>
    <label>ID пользователя</label><input id="book_user_id" required>
    <button onclick="bookEvent()">Забронировать</button>
    <pre id="book_result"></pre>
  </div>

  <div class="block">
    <h2>5. Подтвердить бронь</h2>
    <label>ID события</label><input id="confirm_event_id" required>
    <label>ID брони</label><input id="confirm_book_id" required>
    <button onclick="confirmBooking()">Подтвердить</button>
    <pre id="confirm_result"></pre>
  </div>

<script>
const API_URL = 'http://localhost:8080';

function showError(id, msg) {
  document.getElementById(id).textContent = JSON.stringify({error: msg}, null, 2);
}

async function createUser() {
  const email = document.getElementById('user_email').value.trim();
  const name = document.getElementById('user_name').value.trim();
  const telegram = document.getElementById('user_telegram').value.trim();

  if (!email || !name || !telegram)
    return showError('user_result', 'Все поля обязательны');

  const body = { email, name, telegram_id: telegram };
  const res = await fetch(`${API_URL}/user`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  document.getElementById('user_result').textContent = JSON.stringify(data, null, 2);
}

async function createEventRequest() {
  const title = document.getElementById('event_title').value.trim();
  const desc = document.getElementById('event_description').value.trim();
  const dateVal = document.getElementById('event_date').value;
  const total = document.getElementById('event_total').value;
  const available = document.getElementById('event_available').value;
  const ttl = document.getElementById('event_ttl').value;

  if (!title || !desc || !dateVal || !total || !available || !ttl)
    return showError('event_result', 'Все поля обязательны');

  const isoDate = new Date(dateVal).toISOString();

  const body = {
    title,
    description: desc,
    date: isoDate,
    total_seats: parseInt(total),
    available_seats: parseInt(available),
    requires_payment: document.getElementById('event_payment').checked,
    booking_ttl: parseInt(ttl)
  };

  const res = await fetch(`${API_URL}/events`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();
  document.getElementById('event_result').textContent = JSON.stringify(data, null, 2);
}

async function getEvent() {
  const id = document.getElementById('get_event_id').value.trim();
  if (!id) return showError('get_event_result', 'ID обязателен');
  const res = await fetch(`${API_URL}/events/${id}`);
  const data = await res.json();
  document.getElementById('get_event_result').textContent = JSON.stringify(data, null, 2);
}

async function bookEvent() {
  const eventId = document.getElementById('book_event_id').value.trim();
  const userId = document.getElementById('book_user_id').value.trim();
  if (!eventId || !userId)
    return showError('book_result', 'ID события и пользователя обязательны');
  const res = await fetch(`${API_URL}/events/${eventId}/book?user=${userId}`, { method: 'POST' });
  const data = await res.json();
  document.getElementById('book_result').textContent = JSON.stringify(data, null, 2);
}

async function confirmBooking() {
  const eventId = document.getElementById('confirm_event_id').value.trim();
  const bookId = document.getElementById('confirm_book_id').value.trim();
  if (!eventId || !bookId) {
    document.getElementById('confirm_result').textContent = 'ID события и ID брони обязательны';
    return;
  }

  const res = await fetch(`${API_URL}/events/${eventId}/confirm?book=${bookId}`, {
    method: 'POST'
  });

  let resultText = '';
  if (res.ok) {
    resultText = 'Бронь подтверждена';
  } else {
    resultText = `Ошибка: ${res.status} ${res.statusText}`;
    try {
      const json = await res.json();
      resultText += '\n' + JSON.stringify(json, null, 2);
    } catch {
    }
  }

  document.getElementById('confirm_result').textContent = resultText;
}
</script>

</body>
</html>
